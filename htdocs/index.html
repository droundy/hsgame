<html><head><title>Chat test</title>
<script type="text/javascript"
        src="http://pages.physics.cornell.edu/~shicks/jquery-1.3.2.min.js"
></script>
</head>
<body id="body-root" style="text-align:center">

<div id="chatarea" style="display:none">
<textarea id="chat" cols="80" rows="10" readonly></textarea>
<br/>
<input id="input" type="text" size="60"/>
<input id="say" type="submit" value="say"/>
</div>

<div id="sillyarea" style="display:none">
<textarea id="silly" cols="80" rows="10" readonly></textarea>
<br/>
<input id="sillyinput" type="text" size="60"/>
<input id="sillysay" type="submit" value="silly"/>
<input id="startgame" type="submit" value="Start game!"/>
</div>

<div id="loginarea">
Your name, please:
<input id="name" type="text" size="20"/>
<input id="login" type="submit" value="login"/>
</div>
<div id="test"></div>

<script>$(function(){

  var pollFunction = function(){
    $.ajax({
      url: "/poll",
      data: {u:$.user},
      complete: poll,
      dataType: "script"
    });
  }
  var poll = pollFunction;

  $.login = {
    success: function(){
      $.user = $("#name").val();
      $("#loginarea").hide();
      $("#chatarea").show();
      $("#sillyarea").show();
      poll = pollFunction;
      $.ajax({url:"/chat/join",data:{u:$.user},dataType:"script"});
      $.ajax({url:"/silly/join",data:{u:$.user},dataType:"script"});
      poll();
    },
    fail: function(){
      alert("Username in use.");
    },
    relog: function(){
      $.user = "";            // undefined?
      $("#loginarea").show();
      $("#chatarea").hide();
      $("#sillyarea").hide();
      poll = function(){};    // can we stop polling?
      $.ajax({url:"/login",data:{u:$.user},dataType:"script"});
    }
  };

  $.chat = {
    say: function(msg){
      $("#chat").append(msg).scrollTop(1e10);
    }
  };

  $.silly = {
    say: function(msg){
      $("#silly").append(msg).scrollTop(1e10);
    }
  };

  function login(){
    var name = $("#name").val();
    $("#loginarea").hide();
    $.ajax({
      url: "/login",
      data: {u:name},
      dataType: "script"});
  }
  $("#login").bind("click",function(e){login()});
  $("#name").bind("keypress",function(e){if(e.which==13)login();});

  function say(){
    var inp = $("#input");
    var txt = $("#chat");
    $.ajax({url:"/chat/say",data:{u:$.user,q:inp.attr("value")}});
    inp.val("");
  }
  function silly(){
    var inp = $("#sillyinput");
    var txt = $("#silly");
    $.ajax({url:"/silly/say",data:{u:$.user,q:inp.attr("value")}});
    inp.val("");
  }
  function startgame(){
    $.ajax({url:"/silly/start",data:{u:$.user}});
  }
  $("#say").bind("click",function(e){say()});
  $("#sillysay").bind("click",function(e){silly()});
  $("#startgame").bind("click",function(e){startgame()});
  $("#input").bind("keypress",function(e){if(e.which==13)say();});
  $("#sillyinput").bind("keypress",function(e){if(e.which==13)silly();});

});</script>
